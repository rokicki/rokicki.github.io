!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("alg"),require("kpuzzle")):"function"==typeof define&&define.amd?define(["alg","kpuzzle"],t):"object"==typeof exports?exports.twisty=t(require("alg"),require("kpuzzle")):e.twisty=t(e.alg,e.kpuzzle)}("undefined"!=typeof self?self:this,function(e,t){return function(e){var t={};function r(s){if(t[s])return t[s].exports;var i=t[s]={i:s,l:!1,exports:{}};return e[s].call(i.exports,i,i.exports,r),i.l=!0,i.exports}return r.m=e,r.c=t,r.d=function(e,t,s){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(r.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)r.d(s,i,function(t){return e[t]}.bind(null,i));return s},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=2)}([function(t,r){t.exports=e},function(e,r){e.exports=t},function(e,t,r){"use strict";var s=r(0),i=r(1);const n=new class cursor_CountAnimatedMoves extends s.TraversalUp{traverseSequence(e){var t=0;for(var r of e.nestedUnits)t+=this.traverse(r);return t}traverseGroup(e){return this.traverseSequence(e.nestedSequence)}traverseSiGNMove(e){return 1}traverseCommutator(e){return 2*(this.traverseSequence(e.A)+this.traverseSequence(e.B))}traverseConjugate(e){return 2*this.traverseSequence(e.A)+this.traverseSequence(e.B)}traversePause(e){return 0}traverseNewLine(e){return 0}traverseCommentShort(e){return 0}traverseCommentLong(e){return 0}},o=n.traverse.bind(n);class cursor_Cursor{constructor(e,t){this.alg=e,this.puzzle=t,this.setMoves(e),this.setPositionToStart(),this.durationFn=new cursor_Cursor.AlgDuration(cursor_Cursor.DefaultDurationForAmount)}setMoves(e){var t=Object(s.expand)(e);if(t instanceof s.Sequence?this.moves=t:this.moves=new s.Sequence([t]),0===this.moves.nestedUnits.length)throw"empty alg"}algDuration(){return this.durationFn.traverse(this.moves)}numMoves(){return o(this.moves)}setPositionToStart(){this.moveIdx=0,this.moveStartTimestamp=0,this.algTimestamp=0,this.state=this.puzzle.startState()}setPositionToEnd(){this.setPositionToStart(),this.forward(this.algDuration(),!1)}startOfAlg(){return 0}endOfAlg(){return this.algDuration()}moveDuration(){return this.durationFn.traverse(this.moves.nestedUnits[this.moveIdx])}currentPosition(){var e={state:this.state,moves:[]},t=this.moves.nestedUnits[this.moveIdx],r=this.algTimestamp-this.moveStartTimestamp;return 0!==r&&e.moves.push({move:t,direction:cursor_Cursor.Direction.Forwards,fraction:r/this.durationFn.traverse(new s.Sequence([t]))}),e}currentTimestamp(){return this.algTimestamp}delta(e,t){return e>0?this.forward(e,t):this.backward(-e,t)}forward(e,t){if(e<0)throw"negative";for(var r=this.algTimestamp-this.moveStartTimestamp+e;this.moveIdx<this.numMoves();){var i=this.moves.nestedUnits[this.moveIdx];if(!(i instanceof s.SiGNMove))throw"TODO - only SiGNMove supported";var n=this.durationFn.traverse(i);if(r<n)return this.algTimestamp=this.moveStartTimestamp+r,!1;if(this.state=this.puzzle.combine(this.state,this.puzzle.stateFromMove(i)),this.moveIdx+=1,this.moveStartTimestamp+=n,this.algTimestamp=this.moveStartTimestamp,r-=n,t)return r>0}return!0}backward(e,t){if(e<0)throw"negative";for(var r=this.algTimestamp-this.moveStartTimestamp-e;this.moveIdx>=0;){if(r>=0)return this.algTimestamp=this.moveStartTimestamp+r,!1;if(t||0===this.moveIdx)return this.algTimestamp=this.moveStartTimestamp,!0;var i=this.moves.nestedUnits[this.moveIdx-1];if(!(i instanceof s.SiGNMove))throw"TODO - only SiGNMove supported";this.state=this.puzzle.combine(this.state,this.puzzle.invert(this.puzzle.stateFromMove(i)));var n=this.durationFn.traverse(i);this.moveIdx-=1,this.moveStartTimestamp-=n,this.algTimestamp=this.moveStartTimestamp,r+=n}return!0}}!function(e){let t,r;function i(e){switch(Math.abs(e)){case 0:return 0;case 1:return 1e3;case 2:return 1500;default:return 2e3}}!function(e){e[e.Forwards=1]="Forwards",e[e.Paused=0]="Paused",e[e.Backwards=-1]="Backwards"}(t=e.Direction||(e.Direction={})),function(e){e[e.Move=0]="Move",e[e.EntireMoveSequence=1]="EntireMoveSequence"}(r=e.BreakpointType||(e.BreakpointType={})),e.ConstantDurationForAmount=function(e){return 1e3},e.DefaultDurationForAmount=i;e.AlgDuration=class AlgDuration extends s.TraversalUp{constructor(e=i){super(),this.durationForAmount=e}traverseSequence(e){var t=0;for(var r of e.nestedUnits)t+=this.traverse(r);return t}traverseGroup(e){return e.amount*this.traverse(e.nestedSequence)}traverseSiGNMove(e){return this.durationForAmount(e.amount)}traverseCommutator(e){return 2*e.amount*(this.traverse(e.A)+this.traverse(e.B))}traverseConjugate(e){return e.amount*(2*this.traverse(e.A)+this.traverse(e.B))}traversePause(e){return this.durationForAmount(1)}traverseNewLine(e){return this.durationForAmount(1)}traverseCommentShort(e){return this.durationForAmount(0)}traverseCommentLong(e){return this.durationForAmount(0)}}}(cursor_Cursor||(cursor_Cursor={}));class Dispatcher{constructor(){this.cursorObservers=new Set,this.directionObservers=new Set,this.jumpObservers=new Set}registerCursorObserver(e){if(this.cursorObservers.has(e))throw"Duplicate cursor observer added.";this.cursorObservers.add(e)}registerDirectionObserver(e){if(this.directionObservers.has(e))throw"Duplicate direction observer added.";this.directionObservers.add(e)}registerJumpObserver(e){if(this.jumpObservers.has(e))throw"Duplicate direction observer added.";this.jumpObservers.add(e)}animCursorChanged(e){for(var t of this.cursorObservers)t.animCursorChanged(e)}animDirectionChanged(e){for(var t of this.directionObservers)t.animDirectionChanged(e)}animCursorJumped(){for(var e of this.jumpObservers)e.animCursorJumped()}}class anim_AnimModel{constructor(e){this.cursor=e,this.lastCursorTime=0,this.direction=cursor_Cursor.Direction.Paused,this.breakpointType=cursor_Cursor.BreakpointType.EntireMoveSequence,this.tempo=1.5,this.dispatcher=new Dispatcher,this.scheduler=new FrameScheduler(this.frame.bind(this))}getBounds(){return[this.cursor.startOfAlg(),this.cursor.endOfAlg()]}timeScaling(){return this.direction*this.tempo}updateCursor(e){if(this.direction!==cursor_Cursor.Direction.Paused){var t=e-this.lastCursorTime;this.lastCursorTime=e,t<0&&(t=0),this.cursor.delta(t*this.timeScaling(),this.breakpointType===cursor_Cursor.BreakpointType.Move)&&(this.setDirection(cursor_Cursor.Direction.Paused),this.scheduler.stop())}else this.lastCursorTime=e}setDirection(e){this.direction=e,this.dispatcher.animDirectionChanged(e)}frame(e){this.updateCursor(e),this.dispatcher.animCursorChanged(this.cursor)}setBreakpointType(e){this.breakpointType=e}isPaused(){return this.direction===cursor_Cursor.Direction.Paused}animateDirection(e){this.direction!==e&&(this.updateCursor(performance.now()),this.setDirection(e),e===cursor_Cursor.Direction.Paused?this.scheduler.stop():this.scheduler.start())}skipAndPauseTo(e){this.pause(),this.cursor.setPositionToStart(),this.cursor.forward(e,!1),this.scheduler.singleFrame()}playForward(){this.setBreakpointType(cursor_Cursor.BreakpointType.EntireMoveSequence),this.animateDirection(cursor_Cursor.Direction.Forwards)}pause(){this.animateDirection(cursor_Cursor.Direction.Paused)}playBackward(){this.setBreakpointType(cursor_Cursor.BreakpointType.EntireMoveSequence),this.animateDirection(cursor_Cursor.Direction.Backwards)}skipToStart(){this.skipAndPauseTo(this.cursor.startOfAlg()),this.dispatcher.animCursorJumped()}skipToEnd(){this.skipAndPauseTo(this.cursor.endOfAlg()),this.dispatcher.animCursorJumped()}isAtEnd(){return this.cursor.currentTimestamp()==this.cursor.endOfAlg()}stepForward(){this.cursor.forward(.1,!1),this.setBreakpointType(cursor_Cursor.BreakpointType.Move),this.animateDirection(cursor_Cursor.Direction.Forwards)}stepBackward(){this.cursor.backward(.1,!1),this.setBreakpointType(cursor_Cursor.BreakpointType.Move),this.animateDirection(cursor_Cursor.Direction.Backwards)}togglePausePlayForward(){this.isPaused()?this.playForward():this.pause()}}class FrameScheduler{constructor(e){this.callback=e,this.animating=!1}animFrame(e){this.callback(e),this.animating&&requestAnimationFrame(this.animFrame.bind(this))}start(){this.animating||(this.animating=!0,requestAnimationFrame(this.animFrame.bind(this)))}stop(){this.animating=!1}singleFrame(){this.start(),this.stop()}}class Puzzle{multiply(e,t){if(t<0)return this.invert(this.multiply(e,-t));for(var r=this.startState(),s=0;s<t;s++)r=this.combine(r,e);return r}}class puzzle_KSolvePuzzle extends Puzzle{constructor(e){super(),this.definition=e}static fromID(e){return new puzzle_KSolvePuzzle(i.Puzzles[e])}startState(){return this.definition.startPieces}invert(e){return Object(i.Invert)(this.definition,e)}combine(e,t){return Object(i.Combine)(this.definition,e,t)}stateFromMove(e){return Object(i.stateForSiGNMove)(this.definition,e)}equivalent(e,t){return Object(i.EquivalentStates)(this.definition,e,t)}}var a;!function(e){e.element=function(){return document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement||document.webkitFullscreenElement},e.request=function(e){(e.requestFullscreen||e.mozRequestFullScreen||e.msRequestFullscreen||e.webkitRequestFullscreen).call(e)},e.exit=function(){(document.exitFullscreen||document.mozCancelFullScreen||document.msExitFullscreen||document.webkitExitFullscreen).call(document)}}(a||(a={}));class widget_Button{constructor(e,t){this.element=document.createElement("button"),this.element.title=e,this.element.classList.add(t),this.element.addEventListener("click",this.onpress.bind(this))}}!function(e){e.Fullscreen=class Fullscreen extends e{constructor(e){super("Full Screen","fullscreen"),this.fullscreenElement=e}onpress(){a.element()===this.fullscreenElement?a.exit():a.request(this.fullscreenElement)}};e.SkipToStart=class SkipToStart extends e{constructor(e){super("Skip To Start","skip-to-start"),this.anim=e}onpress(){this.anim.skipToStart()}};e.SkipToEnd=class SkipToEnd extends e{constructor(e){super("Skip To End","skip-to-end"),this.anim=e}onpress(){this.anim.skipToEnd()}};e.PlayPause=class PlayPause extends e{constructor(e){super("Play","play"),this.anim=e,this.anim.dispatcher.registerDirectionObserver(this)}onpress(){this.anim.isPaused()&&this.anim.isAtEnd()&&this.anim.skipToStart(),this.anim.togglePausePlayForward()}animDirectionChanged(e){var t=e===cursor_Cursor.Direction.Paused?"play":"pause";this.element.classList.remove("play","pause"),this.element.classList.add(t),this.element.title=e===cursor_Cursor.Direction.Paused?"Play":"Pause"}};e.StepForward=class StepForward extends e{constructor(e){super("Step forward","step-forward"),this.anim=e}onpress(){this.anim.stepForward()}};e.StepBackward=class StepBackward extends e{constructor(e){super("Step backward","step-backward"),this.anim=e}onpress(){this.anim.stepBackward()}}}(widget_Button||(widget_Button={}));class ControlBar{constructor(e,t){this.anim=e,this.twistyElement=t,this.element=document.createElement("twisty-control-bar"),this.element.appendChild(new widget_Button.Fullscreen(t).element),this.element.appendChild(new widget_Button.SkipToStart(e).element),this.element.appendChild(new widget_Button.StepBackward(e).element),this.element.appendChild(new widget_Button.PlayPause(e).element),this.element.appendChild(new widget_Button.StepForward(e).element),this.element.appendChild(new widget_Button.SkipToEnd(e).element)}}class Scrubber{constructor(e){this.anim=e,this.element=document.createElement("input"),this.element.classList.add("scrubber"),this.element.type="range",this.element.addEventListener("input",this.oninput.bind(this));var t=this.anim.getBounds();this.element.min=String(t[0]),this.element.max=String(t[1]),this.element.value=String(this.anim.cursor.currentTimestamp()),this.anim.dispatcher.registerCursorObserver(this)}updateBackground(){var e=parseInt(this.element.min),t=parseInt(this.element.max),r=(parseInt(this.element.value)-e)/t*100;this.element.style.background=`linear-gradient(to right,       rgb(204, 24, 30) 0%,       rgb(204, 24, 30) ${r}%,       rgba(0, 0, 0, 0.25) ${r}%,       rgba(0, 0, 0, 0.25) 100%      )`}oninput(){this.anim.skipAndPauseTo(parseInt(this.element.value)),this.updateBackground()}animCursorChanged(e){this.element.value=String(e.currentTimestamp()),this.updateBackground()}animBoundsChanged(){this.updateBackground()}}class widget_CursorTextMoveView{constructor(e){this.anim=e,this.element=document.createElement("cursor-text-view"),this.anim.dispatcher.registerCursorObserver(this);new cursor_Cursor.AlgDuration(cursor_Cursor.DefaultDurationForAmount);this.animCursorChanged(e.cursor)}formatFraction(e){return(String(e)+(Math.floor(e)===e?".":"")+"000000").slice(0,5)}animCursorChanged(e){var t=e.currentPosition(),r=""+Math.floor(e.currentTimestamp());t.moves.length>0&&(r+=" "+Object(s.algToString)(new s.Sequence([t.moves[0].move]))+" "+this.formatFraction(t.moves[0].fraction)),this.element.textContent=r}}class widget_KSolveView{constructor(e,t){this.anim=e,this.definition=t,this.element=document.createElement("ksolve-svg-view"),this.anim.dispatcher.registerCursorObserver(this),this.anim.dispatcher.registerJumpObserver(this),this.svg=new i.SVG(t),this.element.appendChild(this.svg.element)}animCursorChanged(e){var t=e.currentPosition();if(t.moves.length>0){var r=t.moves[0].move,n=this.definition,o=new s.SiGNMove(r.outerLayer,r.innerLayer,r.family,r.amount*t.moves[0].direction),a=Object(i.Combine)(n,t.state,Object(i.stateForSiGNMove)(n,o));this.svg.draw(this.definition,t.state,a,t.moves[0].fraction)}else this.svg.draw(this.definition,t.state)}animCursorJumped(){console.log("jumped KSolve"),this.element.classList.add("flash"),setTimeout(()=>this.element.classList.remove("flash"),0)}}class Player{constructor(e,t){this.anim=e,this.element=document.createElement("player"),this.element.appendChild(new widget_KSolveView(this.anim,t).element),this.element.appendChild(new Scrubber(this.anim).element),this.element.appendChild(new ControlBar(this.anim,this.element).element),this.element.appendChild(new widget_CursorTextMoveView(this.anim).element)}}class TwistyParams{}class twisty_Twisty{constructor(e,t={}){this.element=e,this.alg=t.alg||s.Example.Niklas,this.puzzleDef=t.puzzle||i.Puzzles[333],this.cursor=new cursor_Cursor(this.alg,new puzzle_KSolvePuzzle(this.puzzleDef)),this.anim=new anim_AnimModel(this.cursor),this.element.appendChild(new Player(this.anim,this.puzzleDef).element)}}function u(e){const t=e.getAttribute("initialization");var r=function(e){var t=new TwistyParams,r=e.getAttribute("puzzle");r&&(t.puzzle=i.Puzzles[r]);var n=e.getAttribute("alg");return n&&(t.alg=Object(s.parse)(n)),t}(e);"custom"!==t&&new twisty_Twisty(e,r)}"undefined"!=typeof window&&window.addEventListener("load",function(){const e=document.querySelectorAll("twisty");console.log(`Found ${e.length} twisty elem${1===e.length?"":"s"} on page.`);for(let t=0;t<e.length;t++)u(e[t])}),r.d(t,"Twisty",function(){return twisty_Twisty})}])});
//# sourceMappingURL=twisty.js.map